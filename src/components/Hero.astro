---
const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000';
---

<section class="relative pt-24 pb-16 lg:pt-32 lg:pb-24 overflow-hidden">
  <!-- Background gradient -->
  <div class="absolute inset-0 bg-gradient-to-br from-primary-50 via-white to-emerald-50 -z-10"></div>

  <!-- Decorative elements -->
  <div class="absolute top-20 left-10 w-72 h-72 bg-primary-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-pulse"></div>
  <div class="absolute bottom-20 right-10 w-72 h-72 bg-emerald-200 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-pulse"></div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center">
      <!-- Badge -->
      <div class="inline-flex items-center px-4 py-1.5 bg-primary-100 text-primary-700 rounded-full text-sm font-medium mb-6 animate-fade-in-up">
        <span class="w-2 h-2 bg-primary-500 rounded-full mr-2"></span>
        Plataforma de Comunicacion Escolar
      </div>

      <!-- Main heading -->
      <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-gray-900 tracking-tight animate-fade-in-up animation-delay-100">
        Conecta tu colegio
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary-600 to-emerald-600">
          con las familias
        </span>
      </h1>

      <!-- Subtitle -->
      <p class="mt-6 text-xl text-gray-600 max-w-2xl mx-auto animate-fade-in-up animation-delay-200">
        Circulares, autorizaciones, eventos y mensajeria en una sola plataforma.
        Simplifica la comunicacion y ahorra horas de trabajo administrativo.
      </p>

      <!-- CTA buttons -->
      <div class="mt-10 flex flex-col sm:flex-row items-center justify-center gap-4 animate-fade-in-up animation-delay-300">
        <a
          href="#signup"
          class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-4 bg-primary-600 text-white font-semibold rounded-xl hover:bg-primary-700 shadow-lg shadow-primary-600/25 transition-all hover:shadow-xl hover:shadow-primary-600/30 hover:-translate-y-0.5"
        >
          Probar Gratis
          <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </a>
        <button
          type="button"
          id="open-login-modal"
          class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-4 bg-white text-gray-700 font-semibold rounded-xl border border-gray-200 hover:border-primary-300 hover:text-primary-600 transition-all"
        >
          <svg class="mr-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
          </svg>
          Ya tengo cuenta
        </button>
      </div>

      <!-- Trust badges -->
      <div class="mt-16 flex flex-wrap items-center justify-center gap-x-8 gap-y-4 text-gray-400">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span class="text-sm">14 dias gratis</span>
        </div>
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span class="text-sm">Sin tarjeta de credito</span>
        </div>
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span class="text-sm">Soporte incluido</span>
        </div>
      </div>

      <!-- Stats -->
      <div class="mt-16 grid grid-cols-3 gap-8 max-w-2xl mx-auto animate-fade-in-up animation-delay-300">
        <div class="text-center">
          <div class="text-3xl font-bold text-gray-900">+50</div>
          <div class="text-sm text-gray-500 mt-1">Colegios activos</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-gray-900">+15k</div>
          <div class="text-sm text-gray-500 mt-1">Familias conectadas</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-gray-900">98%</div>
          <div class="text-sm text-gray-500 mt-1">Satisfaccion</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Login Modal -->
<div id="login-modal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div id="login-modal-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

  <!-- Modal content -->
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative animate-fade-in-up">
      <!-- Close button -->
      <button
        type="button"
        id="close-login-modal"
        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Modal header -->
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Ingresar a tu colegio</h2>
      <p class="text-gray-600 mb-6">Ingresa el subdominio de tu colegio para acceder</p>

      <!-- Subdomain form -->
      <div class="space-y-4">
        <div>
          <label for="login-subdomain" class="block text-sm font-medium text-gray-700 mb-2">
            Subdominio del colegio
          </label>
          <div class="flex">
            <input
              type="text"
              id="login-subdomain"
              name="login-subdomain"
              pattern="[a-z0-9-]+"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-l-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
              placeholder="mi-colegio"
            />
            <span class="inline-flex items-center px-4 py-3 bg-gray-100 border border-l-0 border-gray-300 rounded-r-xl text-gray-600">
              .kairos.app
            </span>
          </div>
        </div>

        <button
          type="button"
          id="go-to-login"
          class="w-full py-3 px-6 bg-primary-600 text-white font-semibold rounded-xl hover:bg-primary-700 focus:ring-4 focus:ring-primary-500/50 transition-all"
        >
          Ir al Login
        </button>
      </div>

      <!-- Divider -->
      <div class="relative my-6">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-200"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-4 bg-white text-gray-500">o buscar por email</span>
        </div>
      </div>

      <!-- Email lookup -->
      <div class="space-y-4">
        <div>
          <label for="lookup-email" class="block text-sm font-medium text-gray-700 mb-2">
            Tu email
          </label>
          <input
            type="email"
            id="lookup-email"
            name="lookup-email"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
            placeholder="tu@email.com"
          />
        </div>

        <button
          type="button"
          id="lookup-btn"
          class="w-full py-3 px-6 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-all"
        >
          <span id="lookup-btn-text">Buscar mi colegio</span>
          <span id="lookup-btn-loading" class="hidden">
            <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>

        <!-- Lookup result -->
        <div id="lookup-result" class="hidden"></div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ apiUrl }}>
  // DOM Elements
  const openModalBtn = document.getElementById('open-login-modal');
  const closeModalBtn = document.getElementById('close-login-modal');
  const modal = document.getElementById('login-modal');
  const backdrop = document.getElementById('login-modal-backdrop');
  const subdomainInput = document.getElementById('login-subdomain');
  const goToLoginBtn = document.getElementById('go-to-login');
  const lookupEmailInput = document.getElementById('lookup-email');
  const lookupBtn = document.getElementById('lookup-btn');
  const lookupBtnText = document.getElementById('lookup-btn-text');
  const lookupBtnLoading = document.getElementById('lookup-btn-loading');
  const lookupResult = document.getElementById('lookup-result');

  // Open modal
  openModalBtn?.addEventListener('click', () => {
    modal?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    subdomainInput?.focus();
  });

  // Close modal
  function closeModal() {
    modal?.classList.add('hidden');
    document.body.style.overflow = '';
  }

  closeModalBtn?.addEventListener('click', closeModal);
  backdrop?.addEventListener('click', closeModal);

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
      closeModal();
    }
  });

  // Go to login
  goToLoginBtn?.addEventListener('click', () => {
    const subdomain = subdomainInput?.value?.trim().toLowerCase();
    if (subdomain) {
      // Redirect to the school's login page
      window.location.href = `https://${subdomain}.kairos.app/login`;
    } else {
      subdomainInput?.focus();
    }
  });

  // Enter key on subdomain input
  subdomainInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      goToLoginBtn?.click();
    }
  });

  // Helper to create result elements safely (no innerHTML)
  function createSuccessResult(tenants) {
    const container = document.createElement('div');
    container.className = 'p-4 bg-green-50 border border-green-200 rounded-xl';

    const title = document.createElement('p');
    title.className = 'text-green-800 font-medium mb-3';
    title.textContent = tenants.length > 1 ? 'Encontramos tus colegios:' : 'Encontramos tu colegio:';
    container.appendChild(title);

    tenants.forEach((tenant) => {
      const link = document.createElement('a');
      link.href = `https://${tenant.subdomain}.kairos.app/login`;
      link.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-green-200 hover:border-primary-300 transition-colors mb-2';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'font-medium text-gray-900';
      nameSpan.textContent = tenant.name;

      const arrowSpan = document.createElement('span');
      arrowSpan.className = 'text-primary-600';
      arrowSpan.textContent = 'â†’';

      link.appendChild(nameSpan);
      link.appendChild(arrowSpan);
      container.appendChild(link);
    });

    return container;
  }

  function createNotFoundResult() {
    const container = document.createElement('div');
    container.className = 'p-4 bg-yellow-50 border border-yellow-200 rounded-xl';

    const text = document.createElement('p');
    text.className = 'text-yellow-800';
    text.textContent = 'No encontramos una cuenta con este email. ';

    const link = document.createElement('a');
    link.href = '#signup';
    link.className = 'text-primary-600 hover:underline font-medium';
    link.textContent = 'Crear cuenta nueva';
    link.addEventListener('click', closeModal);

    text.appendChild(link);
    container.appendChild(text);
    return container;
  }

  function createErrorResult(message) {
    const container = document.createElement('div');
    container.className = 'p-4 bg-red-50 border border-red-200 rounded-xl';

    const text = document.createElement('p');
    text.className = 'text-red-800';
    text.textContent = message;

    container.appendChild(text);
    return container;
  }

  // Email lookup
  lookupBtn?.addEventListener('click', async () => {
    const email = lookupEmailInput?.value?.trim();
    if (!email) {
      lookupEmailInput?.focus();
      return;
    }

    // Show loading
    lookupBtn?.setAttribute('disabled', 'true');
    lookupBtnText?.classList.add('hidden');
    lookupBtnLoading?.classList.remove('hidden');

    // Clear previous result
    if (lookupResult) {
      lookupResult.classList.add('hidden');
      lookupResult.replaceChildren();
    }

    try {
      const response = await fetch(`${apiUrl}/api/user/lookup?email=${encodeURIComponent(email)}`);

      if (response.ok) {
        const data = await response.json();

        if (data.tenants && data.tenants.length > 0) {
          lookupResult?.appendChild(createSuccessResult(data.tenants));
        } else {
          lookupResult?.appendChild(createNotFoundResult());
        }
      } else if (response.status === 404) {
        lookupResult?.appendChild(createNotFoundResult());
      } else {
        throw new Error('Error en la busqueda');
      }

      lookupResult?.classList.remove('hidden');
    } catch (error) {
      lookupResult?.appendChild(createErrorResult('Error al buscar. Por favor intenta de nuevo.'));
      lookupResult?.classList.remove('hidden');
    } finally {
      // Reset button
      lookupBtn?.removeAttribute('disabled');
      lookupBtnText?.classList.remove('hidden');
      lookupBtnLoading?.classList.add('hidden');
    }
  });

  // Enter key on email input
  lookupEmailInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      lookupBtn?.click();
    }
  });
</script>
